## 1. 目的
指定したディレクトリ、および**その配下にある全てのサブディレクトリ**から、特定の条件に合致するファイルを特定し、指定されたセルの値を抽出して整形出力する。

## 2. 実行環境
- OS: Windows / macOS 両対応（`pathlib`を必須使用）
- 言語: Python 3.10以上
- 依存ライブラリ: `pandas`, `openpyxl`, `configparser`

## 3. 設定ファイル構成 (`config.ini`)
```ini
[SETTINGS]
# 探索を開始するルートディレクトリのパス
target_dir = ./input
# 抽出対象とするファイル名に含まれるキーワード
search_keyword = 日経平均
# 抽出したいセルの指定 (例: A1, B2 等) ※複数指定はカンマ区切り
target_cells = A1, B1, C1
# 画像判定対象セルの指定 (例: D1, E1 等) ※複数指定はカンマ区切り
# 電子捺印等の画像が存在するかをチェックするセル
image_check_cells = D1, E1
# 出力ファイル名
output_filename = extraction_result.txt
```

## 4. 機能要件
1.  **設定読み込み**: `config.ini`から設定をロードする。
2.  **再帰的ファイル探索 (重要)**:
    - `target_dir`で指定されたフォルダを起点とし、**サブフォルダの中身も再帰的に全て探索すること**。
    - 同一階層に複数のフォルダがある場合、それら全ての中身を順次確認すること。
    - ファイル名に`search_keyword`が含まれるExcel/CSVファイルを抽出する。
3.  **データ抽出**:
    - 各ファイルから`target_cells`で指定された座標のデータを取得。
    - Excel(.xlsx, .xls)およびCSVに対応。
4.  **画像判定機能（電子捺印チェック）**:
    - `image_check_cells`で指定されたセルに画像が存在するかを判定。
    - Excelファイル(.xlsx, .xls)のみ対応（CSVは画像非対応のため判定不要）。
    - 画像の種類は問わない（PNG, JPEG, BMP等すべて検出）。
    - 判定結果は「○」（画像あり）または「×」（画像なし）で出力。
5.  **整形出力**:
    - 結果を`output_filename`に保存。
    - 各行はカンマ区切りとする。
    - **視認性向上**: 各列の最大文字数に合わせてパディングを行い、カンマの位置が垂直に揃うように整形する。

## 5. 出力仕様（イメージ）
```text
Filename             , A1        , B1      , C1  , D1(画像), E1(画像)
root_data.xlsx       , 2023/12/25, 33000.5 , 確定, ○      , ○
sub/folder1/data.csv , 2023/12/26, 33100.2 , 暫定, -      , -
sub/folder2/info.xlsx, 2023/12/27, 33200.0 , 完了, ○      , ×
```

**凡例**:
- `○`: 画像あり
- `×`: 画像なし
- `-`: 画像判定非対応（CSVファイル等）

## 6. 画像判定の技術仕様

### 6.1 画像検出方法
- **openpyxl使用**: `worksheet._images` プロパティから埋め込み画像を取得
- **判定ロジック**: 指定セルの範囲内に画像のアンカーポイントが含まれているかをチェック
- **対象画像形式**: PNG, JPEG, BMP, GIF等（openpyxlが対応する全形式）

### 6.2 画像位置の判定基準
画像のアンカーポイント（左上座標）が指定セルの範囲内にある場合を「画像あり」と判定する。

## 7. エラーハンドリング仕様

### 7.1 ファイル読み込みエラー
- **対象**: 破損したExcelファイル、アクセス権限エラー等
- **処理**: エラーメッセージを日本語で出力し、該当ファイルをスキップして処理を継続
- **ログ出力例**: `エラー: ファイル 'xxx.xlsx' を読み込めません: [詳細]`

### 7.2 セル範囲外エラー
- **対象**: 指定セルがシートの範囲を超えている場合
- **処理**: 空文字列として扱い、警告メッセージを出力
- **ログ出力例**: `警告: ファイル 'xxx.xlsx' にセル 'Z99' が存在しません`

### 7.3 設定ファイルエラー
- **対象**: config.iniが存在しない、必須項目が未設定
- **処理**: プログラムを停止し、エラーメッセージを表示
- **ログ出力例**: `エラー: config.iniが見つかりません`

## 8. ログ出力仕様

### 8.1 進捗ログ
```
[INFO] 探索開始: /Users/xxx/input
[INFO] スキャン中: /Users/xxx/input/sub/folder1
[INFO] 発見: root_data.xlsx
[INFO] 発見: sub/folder1/data.csv
[INFO] 処理完了: 3ファイル処理
```

### 8.2 エラーログ
```
[ERROR] ファイル読み込み失敗: broken_file.xlsx (理由: ファイルが破損しています)
[WARNING] セル範囲外: file.xlsx のセル 'AA100'
```

## 9. 実装上の注意点
- **パスの正規化**: `pathlib.Path.rglob()` 等を使用し、OSに依存しない再帰探索を実装すること。
- **重複・無限ループ防止**: 適切にファイルのみを対象とし、ディレクトリ自体を読み込もうとしないこと。
- **進捗表示**: 探索に時間がかかる可能性があるため、現在どのフォルダをスキャンしているかログ出力（print）すること。
- **画像判定の効率化**: 画像判定は openpyxl の _images プロパティを使用し、シート全体をスキャンしない。
- **エンコーディング**: 出力ファイルは UTF-8 で保存すること。

## 10. テスト要件

### 10.1 ユニットテスト対象
- 設定ファイル読み込み機能
- ファイル探索機能（再帰探索）
- セル値抽出機能
- 画像判定機能
- 出力整形機能

### 10.2 統合テスト
- サンプルディレクトリ構造での動作確認
- 画像あり/なしのExcelファイルでの動作確認
- エラーハンドリングの動作確認

---
